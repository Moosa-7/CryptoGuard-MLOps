name: MLOps Production Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ---------------------------------------------------
  # JOB 1: CONTINUOUS INTEGRATION
  # ---------------------------------------------------
  ci-tests:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3
        with:
              lfs: true

      - name: üêç Set up Python 3.12  # <--- CRITICAL FIX HERE
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"     # Changed to 3.12 to match requirements.txt
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Linting (Flake8)
        run: |
          pip install flake8
          flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: üß™ Run Unit & Integration Tests
        run: |
          python -m pytest tests/

  # ---------------------------------------------------
  # JOB 2: CONTINUOUS TRAINING
  # ---------------------------------------------------
  continuous-training:
    needs: ci-tests
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: üêç Set up Python 3.12  # <--- CRITICAL FIX HERE
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"     # Changed to 3.12
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: üõ†Ô∏è Generate Mock Data
        run: |
          python -m src.utils.mock_data

      - name: üèãÔ∏è‚Äç‚ôÇÔ∏è Execute Training Pipeline
        env:
          PYTHONIOENCODING: "utf-8"
        run: |
          python -m src.pipelines.training_pipeline

      - name: üìä Upload Trained Models as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: models/
          retention-days: 1

  # ---------------------------------------------------
  # JOB 3: CONTINUOUS DELIVERY
  # ---------------------------------------------------
  cd-deploy:
    needs: continuous-training
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: ‚¨áÔ∏è Download Trained Models
        uses: actions/download-artifact@v4
        with:
          name: trained-models
          path: models/

      - name: üê≥ Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- üÜï FIX: CONVERT TO LOWERCASE ---
      - name: üî° Lowercase Image Name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: üî® Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # Use the new lowercase ${{ env.IMAGE_NAME }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}