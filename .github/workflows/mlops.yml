name: MLOps Production Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual trigger button

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ---------------------------------------------------
  # JOB 1: CONTINUOUS INTEGRATION (Code Quality & Logic)
  # ---------------------------------------------------
  ci-tests:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Linting (Flake8)
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: ğŸ§ª Run Unit & Integration Tests
        run: |
          # We need inference logic to work, mock data not needed for unit tests usually
          # as we used mocks in pytest, but let's be safe.
          python -m pytest tests/

  # ---------------------------------------------------
  # JOB 2: CONTINUOUS TRAINING (Model Training Verification)
  # ---------------------------------------------------
  continuous-training:
    needs: ci-tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: ğŸ› ï¸ Generate Mock Data (For CI Speed)
        run: |
          # Create fake creditcard.csv so training script runs
          python -m src.utils.mock_data

      - name: ğŸ‹ï¸â€â™‚ï¸ Execute Training Pipeline
        env:
          PYTHONIOENCODING: "utf-8" # Fix emoji crash on Linux too
        run: |
          # Runs the Prefect Orchestrator
          python -m src.pipelines.training_pipeline

      - name: ğŸ“Š Upload Trained Models as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: models/
          retention-days: 1

  # ---------------------------------------------------
  # JOB 3: CONTINUOUS DELIVERY (Docker Build & Publish)
  # ---------------------------------------------------
  cd-deploy:
    needs: continuous-training
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: â¬‡ï¸ Download Trained Models
        uses: actions/download-artifact@v4
        with:
          name: trained-models
          path: models/

      - name: ğŸ³ Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”¨ Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}